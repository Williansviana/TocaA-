<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TocaAí 🎵 — Identifique e Ouça</title>
  <style>
    :root{--bg:#0b1020;--card:#0f1724;--accent:#00d1ff;--glass: rgba(255,255,255,0.04);--muted:#9aa4b2}
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0}
    body{background:linear-gradient(180deg,#05060a 0%,#071028 100%);color:#e7eef6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
    .app{width:980px;max-width:98%;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;padding:22px;display:grid;grid-template-columns:320px 1fr;gap:18px;box-shadow:0 10px 40px rgba(2,6,23,0.6)}
    .sidebar{background:var(--card);padding:18px;border-radius:12px;min-height:420px}
    .logo{display:flex;gap:12px;align-items:center;margin-bottom:14px}
    .logo .badge{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#6b5bff);display:flex;align-items:center;justify-content:center;font-weight:700}
    .logo h1{font-size:18px}
    .big-btn{width:100%;height:140px;border-radius:12px;background:linear-gradient(135deg, rgba(0,209,255,0.08), rgba(107,91,255,0.06));display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;margin-top:12px}
    .shazam-btn{width:92px;height:92px;border-radius:50%;background:linear-gradient(180deg,#00d1ff,#6b5bff);display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 8px 30px rgba(107,91,255,0.18);cursor:pointer}
    .shazam-btn:active{transform:scale(0.98)}
    .muted{color:var(--muted);font-size:13px}
    .visual{height:56px;margin-top:12px;border-radius:8px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:flex;align-items:center;padding:8px;gap:8px}
    canvas{width:100%;height:100%;display:block}
    .history{margin-top:16px}
    .list-item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;background:var(--glass);margin-bottom:8px}
    .list-item img{width:44px;height:44px;border-radius:6px;object-fit:cover}
    .controls{display:flex;gap:8px;align-items:center;margin-top:10px}

    /* main */
    .main{background:var(--card);padding:18px;border-radius:12px;min-height:420px;display:flex;flex-direction:column}
    .search{display:flex;gap:8px}
    .search input{flex:1;padding:10px;border-radius:8px;border:0;background:transparent;color:inherit;outline:none;border:1px solid rgba(255,255,255,0.03)}
    .results{margin-top:18px;display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .track{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));padding:12px;border-radius:10px;display:flex;flex-direction:column;gap:8px}
    .track img{width:100%;height:110px;object-fit:cover;border-radius:8px}
    .track .meta{display:flex;justify-content:space-between;align-items:center}
    .player{margin-top:auto;background:linear-gradient(180deg, rgba(0,0,0,0.15), rgba(255,255,255,0.02));padding:12px;border-radius:10px;display:flex;gap:12px;align-items:center}
    .player img{width:56px;height:56px;object-fit:cover;border-radius:8px}
    .player .info{flex:1}
    .chip{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:13px;color:var(--muted)}
    .small{font-size:13px;color:var(--muted)}
    .center{text-align:center}
    .kbd{background:rgba(0,0,0,0.25);padding:2px 8px;border-radius:6px}

    @media (max-width:880px){.app{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="logo">
        <div class="badge">🎵</div>
        <div>
          <h1>TocaAí</h1>
          <div class="small">Reconhece e toca online</div>
        </div>
      </div>

      <div class="big-btn center">
        <div id="recordBtn" class="shazam-btn">🔊</div>
        <div id="status" class="muted">Pronto — clique para identificar</div>
        <div class="visual"><canvas id="viz"></canvas></div>
      </div>

      <div class="controls">
        <button id="stopBtn" class="chip">Parar</button>
        <button id="clearHistory" class="chip">Limpar histórico</button>
        <div style="flex:1;text-align:right" class="small">Permissões: <span id="perm">?</span></div>
      </div>

      <div class="history">
        <h3 style="margin:8px 0 6px 0">Histórico</h3>
        <div id="historyList">
          <!-- músicas identificadas aparecem aqui -->
        </div>
      </div>
    </aside>

    <main class="main">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div style="display:flex;gap:8px;align-items:center;flex:1">
          <input id="searchInput" placeholder="Buscar músicas, artistas..."/>
          <button id="searchBtn" class="chip">Buscar</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="chip">Top</div>
          <div class="chip">Gravadas</div>
        </div>
      </div>

      <div class="results" id="results"></div>

      <div class="player" id="player" style="display:none">
        <img id="playerCover" src="" alt="capa"/>
        <div class="info">
          <div id="playerTitle">Título</div>
          <div id="playerArtist" class="small">Artista</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="playPreview" class="chip">▶</button>
          <button id="lyricsBtn" class="chip">Letra</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    // 🔑 Substitua pelo seu token em https://audd.io
    const API_TOKEN = "227fe1def58b5ffe0f0ba666ba4c9963";

    // Elementos
    const recordBtn = document.getElementById('recordBtn');
    const statusEl = document.getElementById('status');
    const permEl = document.getElementById('perm');
    const viz = document.getElementById('viz');
    const stopBtn = document.getElementById('stopBtn');
    const historyList = document.getElementById('historyList');
    const resultsEl = document.getElementById('results');
    const player = document.getElementById('player');
    const playerCover = document.getElementById('playerCover');
    const playerTitle = document.getElementById('playerTitle');
    const playerArtist = document.getElementById('playerArtist');
    const playPreview = document.getElementById('playPreview');
    const lyricsBtn = document.getElementById('lyricsBtn');

    let audioCtx, analyser, sourceNode, mediaStream;
    let raf;
    let recording = false;
    let mediaRecorder;
    let recordedChunks = [];
    let audioPreview = new Audio();

    // Inicializa o visualizador de áudio
    function setupVisualizer() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      viz.width = viz.clientWidth * devicePixelRatio;
      viz.height = viz.clientHeight * devicePixelRatio;
      const canvasCtx = viz.getContext('2d');

      function draw() {
        raf = requestAnimationFrame(draw);
        if (!analyser) return;
        const bufferLength = analyser.frequencyBinCount;
        const data = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(data);
        canvasCtx.clearRect(0, 0, viz.width, viz.height);
        const barWidth = viz.width / bufferLength;
        for (let i = 0; i < bufferLength; i++) {
          const v = data[i] / 255;
          const h = v * viz.height;
          canvasCtx.fillStyle = `rgba(0,209,255,${0.15 + v * 0.6})`;
          canvasCtx.fillRect(i * barWidth, viz.height - h, barWidth * 0.9, h);
        }
      }
      draw();
    }

    async function startCapture() {
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        permEl.textContent = 'OK';
        if (!audioCtx) setupVisualizer();
        if (sourceNode) sourceNode.disconnect();
        sourceNode = audioCtx.createMediaStreamSource(mediaStream);
        sourceNode.connect(analyser);

        mediaRecorder = new MediaRecorder(mediaStream);
        recordedChunks = [];

        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.onstop = async () => {
          const blob = new Blob(recordedChunks, { type: 'audio/webm' });
          statusEl.textContent = 'Enviando para identificação...';
          await identifyMusic(blob);
        };
      } catch (e) {
        permEl.textContent = 'Negado';
        statusEl.textContent = 'Permissão negada. Ative o microfone.';
        console.error(e);
      }
    }

    recordBtn.addEventListener('click', async () => {
      if (!recording) {
        recording = true;
        recordBtn.textContent = '⏺';
        statusEl.textContent = 'Gravando...';
        await startCapture();
        mediaRecorder.start();
      } else {
        recording = false;
        recordBtn.textContent = '🔊';
        statusEl.textContent = 'Processando...';
        mediaRecorder.stop();
        if (mediaStream) {
          mediaStream.getTracks().forEach(t => t.stop());
        }
        cancelAnimationFrame(raf);
      }
    });

    stopBtn.addEventListener('click', () => {
      if (recording) {
        recording = false;
        recordBtn.textContent = '🔊';
        statusEl.textContent = 'Parando...';
        mediaRecorder.stop();
        if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
        cancelAnimationFrame(raf);
      }
    });

    // 🔥 Envia áudio para AudD API
    async function identifyMusic(blob) {
      const formData = new FormData();
      formData.append("file", blob, "recording.webm");
      formData.append("api_token", API_TOKEN);
      formData.append("return", "spotify,apple_music,lyrics");

      try {
        const response = await fetch("https://api.audd.io/", {
          method: "POST",
          body: formData,
        });

        const data = await response.json();

        if (data.status === "success" && data.result) {
          const song = data.result;
          const track = {
            id: song.spotify_id || song.title,
            title: song.title,
            artist: song.artist,
            cover: song.album_cover_url || `https://placehold.co/300x300?text=${encodeURIComponent(song.title)}`,
            preview: song.spotify_url || "",
            lyrics: song.lyrics || "Letra não disponível"
          };

          statusEl.textContent = `Identificado: ${song.title} — ${song.artist}`;
          pushHistory(track);
          showResult(track);
        } else {
          statusEl.textContent = "❌ Música não identificada.";
          showResult({
            title: "Não encontrada",
            artist: "Tente novamente com áudio mais claro",
            cover: "",
            preview: ""
          });
        }
      } catch (err) {
        console.error("Erro:", err);
        statusEl.textContent = "❌ Erro na conexão.";
      }
    }

    function pushHistory(track) {
      const item = document.createElement('div');
      item.className = 'list-item';
      item.innerHTML = `
        <img src="${track.cover}" onerror="this.src='https://placehold.co/64x64?text=?'"/>
        <div style="flex:1">
          <div>${track.title}</div>
          <div class="small">${track.artist}</div>
        </div>
        <div><button class="chip" data-id="${track.id}">Abrir</button></div>
      `;
      historyList.prepend(item);
      item.querySelector('button').addEventListener('click', () => showResult(track));
    }

    function showResult(track) {
      resultsEl.innerHTML = '';
      const card = document.createElement('div');
      card.className = 'track';
      card.innerHTML = `
        <img src="${track.cover}" onerror="this.src='https://placehold.co/300x300?text=Cover'"/>
        <div class="meta">
          <div>
            <strong>${track.title}</strong>
            <div class="small">${track.artist}</div>
          </div>
          <div><button class="chip">Abrir</button></div>
        </div>
      `;
      resultsEl.appendChild(card);
      card.querySelector('button').addEventListener('click', () => openPlayer(track));
    }

    function openPlayer(track) {
      playerCover.src = track.cover;
      playerTitle.textContent = track.title;
      playerArtist.textContent = track.artist;
      player.style.display = 'flex';

      // Tocar no Spotify (sem baixar)
      audioPreview.src = track.preview || '';
      audioPreview.pause();
    }

    playPreview.addEventListener('click', () => {
      if (audioPreview.src && !audioPreview.src.includes('placehold')) {
        if (audioPreview.paused) {
          audioPreview.play();
          playPreview.textContent = '⏸';
        } else {
          audioPreview.pause();
          playPreview.textContent = '▶';
        }
      }
    });

    lyricsBtn.addEventListener('click', () => {
      const track = {
        title: playerTitle.textContent,
        artist: playerArtist.textContent
      };
      alert(`Letra de "${track.title}" - ${track.artist}:\n\n${window.currentLyrics || 'Letra não disponível.'}`);
    });

    document.getElementById('clearHistory').addEventListener('click', () => {
      historyList.innerHTML = '';
    });

    document.getElementById('searchBtn').addEventListener('click', () => {
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      resultsEl.innerHTML = '<div class="small">Busca não implementada no demo.</div>';
    });

    // Inicializa
    setupVisualizer();

    window.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        recordBtn.click();
      }
    });
  </script>
</body>
</html>